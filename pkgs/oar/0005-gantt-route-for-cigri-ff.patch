From a96d1a2c3aca98ef4af376feed8b5f8ba421a940 Mon Sep 17 00:00:00 2001
From: Quentin Guilloteau <Quentin.Guilloteau@inria.fr>
Date: Tue, 9 May 2023 19:10:12 +0200
Subject: [PATCH 5/5] gantt route for cigri ff

---
 oar/lib/basequery.py      | 21 +++++++++++++++++++++
 oar/rest_api/views/job.py | 11 +++++++++++
 2 files changed, 32 insertions(+)

diff --git a/oar/lib/basequery.py b/oar/lib/basequery.py
index 66ad76d..df40c1c 100644
--- a/oar/lib/basequery.py
+++ b/oar/lib/basequery.py
@@ -154,6 +154,27 @@ class BaseQueryCollection(object):
             user, from_time, to_time, states, job_ids, array_id, sql_property
         )
 
+    def get_gantt_prediction(self, horizon):
+        columns = ("job_id", "start_time", "moldable_walltime", "message")
+        query = (
+            # db.query(Job, MoldableJobDescription)
+            db.query(Job)
+            # .outerjoin(MoldableJobDescription, Job.assigned_moldable_job == MoldableJobDescription.id)
+            .join(MoldableJobDescription, Job.id == MoldableJobDescription.id)
+            # .join(AssignedResource, MoldableJobDescription.job_id == AssignedResource.moldable_id)
+            # .join(Resource, Resource.id == AssignedResource.resource_id)
+            .filter(Job.queue_name == "default")
+            .filter(Job.stop_time == 0)
+            .filter(Job.state.in_(["Running", "Suspended", "Resuming", "Waiting", "Launching"]))
+            # .filter(Job.assigned_moldable_job == MoldableJobDescription.id)
+            # .filter(MoldableJobDescription.id == AssignedResource.moldable_id)
+            # .filter(AssignedResource.resource_id == Resource.id)
+            .filter(Job.start_time <= horizon)
+            .filter(Job.start_time + MoldableJobDescription.walltime >= horizon)
+        )
+        return query
+        
+
     def get_resources(self, network_address, detailed=True):
         if detailed:
             query = db.query(Resource)
diff --git a/oar/rest_api/views/job.py b/oar/rest_api/views/job.py
index 7c426d0..54e6ba6 100644
--- a/oar/rest_api/views/job.py
+++ b/oar/rest_api/views/job.py
@@ -328,6 +328,17 @@ def show(job_id, detailed=None):
     g.data["events"] = get_job_events(job_id)
     attach_links(g.data)
 
+@app.route("/gantt", methods=["GET"])
+@app.route("/gantt/<int:horizon>", methods=["GET"])
+def gantt(horizon=0):
+    now = int(time.time())
+    time_horizon = now + horizon
+    query = db.queries.get_gantt_prediction(time_horizon)
+    data = query.all()
+    g.data["now"] = now
+    g.data["horizon"] = time_horizon
+    g.data["items"] = data
+
 
 @app.route("/<int:job_id>/nodes", methods=["GET"])
 @app.args({"offset": Arg(int, default=0), "limit": Arg(int)})
-- 
2.38.1

